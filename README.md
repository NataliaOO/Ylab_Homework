# Product Catalog Service (консольное приложение)

Внутренний сервис маркетплейса для управления каталогом товаров.

Реализовано:

- Модель товара (`Product`) с основными атрибутами (название, бренд, категория, цена, описание).
- CRUD-операции над товарами: добавление, изменение, удаление, просмотр списка.
- Поиск и фильтрация по:
  - категории,
  - бренду,
  - диапазону цен,
  - тексту в названии/описании.
- Авторизация пользователей с ролями:
  - `ADMIN` — полный доступ (CRUD),
  - `VIEWER` — только просмотр и поиск.
- Аудит действий пользователей (логин/логаут, создание/изменение/удаление товара).
- Кэширование результатов поиска (ускорение повторных запросов).
- Сохранение данных между запусками:
  - товары — в файле `products.dat`,
  - аудит — в файле `audit.dat`.
- Простые метрики:
  - количество созданных/обновлённых/удалённых товаров,
  - количество поисковых запросов,
  - количество попаданий в кэш,
  - среднее время выполнения поиска,
  - доля запросов, обслуженных из кэша.

## 1. Требования

- JDK: 17+
- Maven: 3.8+
- PostgreSQL 16 (в Docker)
- Liquibase (XML changelog’и)
- JDBC
- Testcontainers (PostgreSQL)
- Docker + docker-compose

## 2. Хранение данных и БД

Все данные теперь хранятся в **PostgreSQL**:

- **Таблицы сущностей** находятся в схеме `catalog`:
  - `catalog.product` — товары;
  - `catalog.audit` — записи аудита;
  - `catalog.users` — пользователи.
- **Идентификаторы** генерируются через **sequence** (используется `BIGSERIAL` / sequence в DDL).
- **Служебные таблицы Liquibase** находятся в отдельной схеме,  
  а таблицы доменных сущностей в `catalog`.

## 3. Миграции БД (Liquibase)

Все DDL-скрипты и скрипты предзаполнения выполняются **только Liquibase**.

- Changelog’и находятся в каталоге, например:
  - `src/main/resources/db/changelog/db.changelog-master.xml` — мастер-файл;
  - `src/main/resources/db/changelog/00-create-schema.xml` — создание схем (`catalog`, `service` и т.п.);
  - `src/main/resources/db/changelog/01-create-tables.xml` — создание таблиц (`product`, `audit`, `users`, последовательностей и индексов);
  - `src/main/resources/db/changelog/02-insert-data.xml` — предзаполнение тестовыми данными (пользователи, пары демо-товаров и т.п.).

## 4. PostgreSQL в Docker (docker-compose)

Для разработки используется Docker + docker-compose.
В корне проекта находится файл docker-compose.yml, который поднимает контейнер с PostgreSQL.

Запуск PostgreSQL через Docker

Из корня проекта:
```
docker-compose up -d
```
Проверить, что контейнер поднялся:
```
docker ps
```

## 5. Сборка
Из корня проекта:
```
mvn clean package
```

## 6. Запуск

```
java -jar target/product-catalog-service-1.0-SNAPSHOT.jar
```

Или запустить класс `com.marketplace.catalog.Main` из IDE.

## 7. Пользователи

Пользователи теперь хранятся в таблице catalog.users (через JdbcUserRepository).
Тестовые пользователи создаются миграциями или в коде инициализации БД.

Пример стандартных пользователей:

admin / admin — роль ADMIN

user / user — роль VIEWER

## 8. Тесты
Добавлены интеграционные тесты

Для запуска всех модульных тестов:

```
mvn test
```
